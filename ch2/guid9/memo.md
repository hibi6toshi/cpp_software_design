# 抽象化の所有権に注意する

## 依存関係逆転の法則
Rober Martinが述べた抽象化の必要性についての言葉。
```
柔軟性がもっとも高いシステムは、抽象化のみに依存し、具象実装には依存しない設計である。
```

このことを一般には依存関係逆転の原則(DIP Depnedency Inversion Principle)と言います。熊野区すると、依存関係を管理するには、具象型や実装詳細ではなく抽象化に依存すべきであるということです。
この原則では継承階層については何も言及しておらず、抽象化についてのみ行っている点に注意してください。

次の場合を考えてみましょう。ATMの処理を実装するとします。ATMには様々な種類の処理があります。引出(withdrawal)、預入(deposit)、振込(transfer)などです。いずれも扱うのは現金で、処理は完遂するか、またはエラーが発生すれば中断し、全てを基に戻す必要があります。
このような動作を一般に**トランザクション**と言います。従って、Transactionという名前の抽象化を設けます。Deposit, Withdrawal, Transferは全てTransactionの派生とします。

![](/ch2/guid9/transaction1.drawio.png)
**トランザクションとUI間の強い依存関係(最初の案)**

どのトランザクションにも、顧客がUIを用い入力したデータが必要です。UIクラスには入力データを取得する様々な関数が多数あります。
3種類のトランザクションは必要に応じ、これらの関数をコールします。図では黒塗りの矢印でこの関係を表していまます。すなわり、2種類のトランザクションはUIクラスに依存しています。

この状況で何かに変更が加えられたらどうなるでしょうか？例えばVIP向けのSpeedTransferトランザクションを追加しなければならなくなったとしましょう。
UIクラスを変更し、若干の関数追加が必要になります。(例えば、requestSpeedTransferAmount()とrequestVIPNumber())すると、UIクラスに直接依存しているため、他のトランザクションも影響を受けます。

この余計な手間が発生した原因は、アーキテクチャにあります。トランザクションクラスそれぞれがUIクラスに直接依存しているため、トランザクションクラス同士が間接的に相互依存してしまうのです。
トランザクションクラスはアーキテクチャの上位にあり、UIクラスは下位ですが、上位が下位に依存してしまっています。正しくは逆方向の依存関係であるべきです。

UIクラスへの依存関係が原因で、全トランザクションクラスが間接的に相互依存している上に、アーキテクチャの上位が下位に依存しています。UIクラスの具象実装に依存しないよう、抽象化を導入する必要があります。
しかし抽象化1つでは解決できません。3種類あるトランザクションは依然として間接的に関係を持っています。3つの抽象化、トランザクション種類ごとに1つの抽象化が必要です。

![](ch2/guid9/transaction2.drawio.png)
**トランザクションとUI間の依存関係を軽減**

DepositUI、WithdrawalUI、TransferUIの3クラスの導入により、もう具象クラスに依存しておらず、3トランザクション間の依存関係を排除できました。
代わりに、トランザクションクラスが真に必要な処理のみを表現する、軽量な抽象化に依存しています。
この状態からSpeedTransferトランザクションを追加すると、同時にSpeedTransferUI抽象化も追加するため、UIクラスに変更を加えても、他のトランザクションクラスには影響しません。

しかし、ここで導入したのは依存関係のローカルな逆転です。（UIクラスと抽象化クラス内の関係を逆転させた）
アーキテクチャの観点からすると、上位から下位への依存関係がなくなっていないのです。（トランザクションクラスからUI機能への依存関係）すなわち、抽象化を単に導入するだけでは不十分で、**どこに抽象化を導入するか**が重要なのです。

下位が上位へ依存するように、3種類の抽象化を上位に配置した場合の依存関係を示します。
![](ch2/guid9/transaction3.drawio.png)
**上位での抽象化による依存関係逆転**

アーキテクチャの上位で抽象化し、上位を抽象化の所有者にすることで、DIPに真に従えます。すなわち、全ての矢印が下位から上位へ向くようになります。
これで正しいアーキテクチャとなりました。

ただし、これは単なる発想の転換では済まないレベルかもしれません。UIクラスが依存するヘッダーファイルを別のモジュールへ移動したり、異uんするインクルードぶんをガラリと再配置する必要もあるでしょう。
これは単なる発想の転換ではなく、所有権の再割り当てです。

SRPに正しく従うには上位で抽象化するしか方法はありません。
同じものに属するのはUIクラスではなく、トランザクションクラスとそれが依存するUI抽象化です。
依存関係を正しく逆転させるには、抽象化を上位に**所有させなければなりません。**